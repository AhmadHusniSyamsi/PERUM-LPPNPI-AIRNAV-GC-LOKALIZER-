{% extends 'base.html' %}
{% block content %}
<div class="container my-5">
  <h2 class="fw-bold text-center mb-4">DETAIL GROUND CHECK</h2>
  <div class="mb-4">
    <p><strong>Lokasi:</strong> {{ record.lokasi }}</p>
    <p><strong>Tanggal:</strong> {{ record.tanggal.strftime('%d-%m-%Y') }}</p>
    <p><strong>Teknisi:</strong> {{ record.teknisi }}</p>
    <p><strong>Catatan:</strong> {{ record.catatan }}</p>
  </div>
  <div class="table-responsive">
    <table class="table table-bordered text-center align-middle">
      <thead class="table-light">
        <tr>
          <th rowspan="2">FREQ</th>
          <th rowspan="2">JARAK (M)</th>
          <th rowspan="2">DEGREE (°)</th>
          <th colspan="6">TX 1</th>
          <th colspan="6">TX 2</th>
        </tr>
        <tr>
          <th>DDM (%)</th><th>DDM (µA)</th><th>SUM (%)</th>
          <th>MOD 90 Hz</th><th>MOD 150 Hz</th><th>RF LEVEL (dB)</th>
          <th>DDM (%)</th><th>DDM (µA)</th><th>SUM (%)</th>
          <th>MOD 90 Hz</th><th>MOD 150 Hz</th><th>RF LEVEL (dB)</th>
        </tr>
      </thead>
      <tbody>
        {% set data_90hz = rows | selectattr("freq","equalto","90 Hz") | list %}
        {% set data_center = rows | selectattr("freq","equalto","Center") | list %}
        {% set data_150hz = rows | selectattr("freq","equalto","150 Hz") | list %}

        {% for row in data_90hz %}
        <tr>
          {% if loop.first %}<td rowspan="{{ data_90hz|length }}">90 Hz</td>{% endif %}
          <td>{{ row.jarak }}</td>
          <td>{{ row.degree }}</td>
          <td>{{ row.tx1_ddm_persen or '' }}</td>
          <td>{{ row.tx1_ddm_ua or '' }}</td>
          <td>{{ row.tx1_sum or '' }}</td>
          <td>{{ row.tx1_mod90 or '' }}</td>
          <td>{{ row.tx1_mod150 or '' }}</td>
          <td>{{ row.tx1_rf or '' }}</td>
          <td>{{ row.tx2_ddm_persen or '' }}</td>
          <td>{{ row.tx2_ddm_ua or '' }}</td>
          <td>{{ row.tx2_sum or '' }}</td>
          <td>{{ row.tx2_mod90 or '' }}</td>
          <td>{{ row.tx2_mod150 or '' }}</td>
          <td>{{ row.tx2_rf or '' }}</td>
        </tr>
        {% endfor %}

        {% for row in data_center %}
        <tr>
          <td></td>
          <td>{{ row.jarak }}</td>
          <td>{{ row.degree }}</td>
          <td>{{ row.tx1_ddm_persen or '' }}</td>
          <td>{{ row.tx1_ddm_ua or '' }}</td>
          <td>{{ row.tx1_sum or '' }}</td>
          <td>{{ row.tx1_mod90 or '' }}</td>
          <td>{{ row.tx1_mod150 or '' }}</td>
          <td>{{ row.tx1_rf or '' }}</td>
          <td>{{ row.tx2_ddm_persen or '' }}</td>
          <td>{{ row.tx2_ddm_ua or '' }}</td>
          <td>{{ row.tx2_sum or '' }}</td>
          <td>{{ row.tx2_mod90 or '' }}</td>
          <td>{{ row.tx2_mod150 or '' }}</td>
          <td>{{ row.tx2_rf or '' }}</td>
        </tr>
        {% endfor %}

        {% for row in data_150hz %}
        <tr>
          {% if loop.first %}<td rowspan="{{ data_150hz|length }}">150 Hz</td>{% endif %}
          <td>{{ row.jarak }}</td>
          <td>{{ row.degree }}</td>
          <td>{{ row.tx1_ddm_persen or '' }}</td>
          <td>{{ row.tx1_ddm_ua or '' }}</td>
          <td>{{ row.tx1_sum or '' }}</td>
          <td>{{ row.tx1_mod90 or '' }}</td>
          <td>{{ row.tx1_mod150 or '' }}</td>
          <td>{{ row.tx1_rf or '' }}</td>
          <td>{{ row.tx2_ddm_persen or '' }}</td>
          <td>{{ row.tx2_ddm_ua or '' }}</td>
          <td>{{ row.tx2_sum or '' }}</td>
          <td>{{ row.tx2_mod90 or '' }}</td>
          <td>{{ row.tx2_mod150 or '' }}</td>
          <td>{{ row.tx2_rf or '' }}</td>
        </tr>
        {% endfor %}
    </table>
  </div>
  
    
<div class="mb-3">
  <label class="fw-bold me-3">Pilih Grafik:</label>
  <button id="btnNormal" class="btn btn-primary ">Opsi 1</button>
  <button id="btnMirror" class="btn btn-outline-secondary ">Opsi 2</button>
</div>
<div id="normalCharts">
  <canvas id="chartTx1Normal" class="mt-4"></canvas>
  <canvas id="chartTx2Normal" class="mt-4"></canvas>
</div>
<div id="mirrorCharts" style="display:none;">
  <canvas id="chartMirrorCombined" class="mt-4"></canvas>
</div>
<div id="chartOverlay" class="chart-overlay">
  <span class="close-btn" onclick="closeChart()">&times;</span>
  <canvas id="chartFullscreen"></canvas>
</div>
<div class="mt-4">
  <a href="{{ url_for('groundcheck.lihat_data') }}" class="btn btn-outline-dark">Kembali</a>
</div>
</div>

<style>


#chartTx1Normal,
#chartTx2Normal,
#chartTx1Mirror,
#chartTx2Mirror {
  width: 100%;
  height: 60vh;
}


.chart-overlay {
  display: none;
  position: fixed;
  top:0; left:0;
  width: 100vw;
  height: 100vh;
  background: white;
  z-index: 9999;
  justify-content: center;
  align-items: center;
  padding: 10px;
}

.chart-overlay canvas {
  width: 100% !important;
  height: 100% !important;
}

.chart-overlay .close-btn {
  position: absolute;
  top:10px;
  right:15px;
  font-size:28px;
  font-weight:bold;
  color:black;
  cursor:pointer;
}

@media screen and (max-width: 768px) and (orientation: portrait) {
  #chartTx1Normal,
  #chartTx2Normal,
  #chartTx1Mirror,
  #chartTx2Mirror {
    height: 60vh;
    min-height: 300px;
  }

 
  .chart-overlay canvas {
    max-width: 90vw;
    max-height: 70vh;
  }
}


.table-responsive, .chart-container {
  overflow-x: auto;
}

</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  
 
  const normalDiv = document.getElementById("normalCharts");
  const mirrorDiv = document.getElementById("mirrorCharts");
  const btnNormal = document.getElementById("btnNormal");
  const btnMirror = document.getElementById("btnMirror");

  btnNormal.addEventListener("click", () => {
    normalDiv.style.display = "block";
    mirrorDiv.style.display = "none";
    btnNormal.classList.replace("btn-outline-secondary", "btn-primary");
    btnMirror.classList.replace("btn-primary", "btn-outline-secondary");
  });

  btnMirror.addEventListener("click", () => {
    normalDiv.style.display = "none";
    mirrorDiv.style.display = "block";
    btnMirror.classList.replace("btn-outline-secondary", "btn-primary");
    btnNormal.classList.replace("btn-primary", "btn-outline-secondary");
  });

  let degrees = [35,30,25,20,15,10,5,1.85,0,1.85,5,10,15,20,25,30,35];
  let tx1_data = '{{ rows|map(attribute="tx1_ddm_persen")|map("default",0)|list|tojson|safe }}';
  let tx2_data = '{{ rows|map(attribute="tx2_ddm_persen")|map("default",0)|list|tojson|safe }}';

  let tx1 = JSON.parse(tx1_data);
  let tx2 = JSON.parse(tx2_data);

  let chartInstances = {};
  let chartConfigs = [];
  let currentChartIndex = 0;
  let fullChart = null;

  function makeMirror(rawData) {
    let left = rawData.slice(0,8);
    let right = rawData.slice(8);
    let rawMirror = left.concat(right);
    let plotMirror = rawMirror.map(v => Math.abs(v));
    return { rawMirror, plotMirror };
  }
  let tx1Mirror = makeMirror(tx1);
  let tx2Mirror = makeMirror(tx2);

  function renderChart(canvasId, label, rawData, plotData, labels, color) {
    let config = {
      type:'line',
      data:{
        labels: labels.map(d=>d+"°"),
        datasets:[{
          label: label,
          data: plotData,
          borderColor: color,
          backgroundColor: color.replace('1)','0.1)'),
          pointBackgroundColor: color,
          pointRadius:4,
          tension:0.2,
          rawValues: rawData
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio: true,
        layout: { padding: { top: 10, bottom: 10, left: 10, right: 10 } },
        plugins:{
          title:{ display:true, text: label + ' Ground Performance Curve', font:{size:18, weight:'bold'} },
          datalabels:{ 
            color:'black', 
            align:'top', 
            font:{weight:'bold'}, 
            formatter:(v,ctx)=>ctx.dataset.rawValues[ctx.dataIndex]?.toFixed(2)||'' 
          },
          annotation:{
            annotations:{
              verticalLine:{ type:'line', xMin: labels.indexOf(0), xMax: labels.indexOf(0), borderColor:'black', borderWidth:2 },
              horizontalLine:{ type:'line', yMin:0, yMax:0, borderColor:'black', borderWidth:2 }
            }
          }
        },
        scales:{ x:{title:{display:true,text:'Degree (°)'}}, y:{title:{display:true,text:'DDM (%)'}}}
      },
      plugins:[ChartDataLabels]
    };

    if (chartInstances[canvasId]) {
      chartInstances[canvasId].destroy();
    }

    chartInstances[canvasId] = new Chart(
      document.getElementById(canvasId).getContext('2d'),
      config
    );

    chartConfigs.push(config);
    enableFullscreen(canvasId, chartConfigs.length - 1);
  }

  function renderMirrorCombined(canvasId, labels, tx1Mirror, tx2Mirror) {
    let config = {
      type:'line',
      data:{
        labels: labels.map(d=>d+"°"),
        datasets:[
          {
            label:'TX1 Mirror',
            data: tx1Mirror.plotMirror,
            borderColor:'rgba(0,0,255,1)',
            backgroundColor:'rgba(0,0,255,0.1)',
            pointBackgroundColor:'rgba(0,0,255,1)',
            pointRadius:4,
            tension:0.2,
            rawValues: tx1Mirror.rawMirror
          },
          {
            label:'TX2 Mirror',
            data: tx2Mirror.plotMirror,
            borderColor:'rgba(255,0,0,1)',
            backgroundColor:'rgba(255,0,0,0.1)',
            pointBackgroundColor:'rgba(255,0,0,1)',
            pointRadius:4,
            tension:0.2,
            rawValues: tx2Mirror.rawMirror
          }
        ]
      },
      options:{
        responsive:true,
        maintainAspectRatio: true,
        layout: { padding:{ top:10, bottom:10, left:10, right:10 }},
        plugins:{
          title:{ display:true, text:'TX1 & TX2 Ground Performance Curve', font:{size:18, weight:'bold'} },
          datalabels:{
            color:'black',
            align:'top',
            font:{weight:'bold'},
            formatter:(v,ctx)=>ctx.dataset.rawValues[ctx.dataIndex]?.toFixed(2)||''
          },
          annotation:{
            annotations:{
              verticalLine:{ type:'line', xMin: labels.indexOf(0), xMax: labels.indexOf(0), borderColor:'black', borderWidth:2 },
              horizontalLine:{ type:'line', yMin:0, yMax:0, borderColor:'black', borderWidth:2 }
            }
          }
        },
        scales:{ x:{title:{display:true,text:'Degree (°)'}}, y:{title:{display:true,text:'DDM (%)'}}}
      },
      plugins:[ChartDataLabels]
    };

    if (chartInstances[canvasId]) {
      chartInstances[canvasId].destroy();
    }

    chartInstances[canvasId] = new Chart(
      document.getElementById(canvasId).getContext('2d'),
      config
    );

    chartConfigs.push(config);
    enableFullscreen(canvasId, chartConfigs.length - 1);
  }

  function enableFullscreen(canvasId, index) {
    const canvas = document.getElementById(canvasId);
    canvas.addEventListener("click", function() {
      if(window.innerWidth <= 768){
        currentChartIndex = index;
        showChart();
      }
    });
  }

  function showChart() {
    const overlay = document.getElementById("chartOverlay");
    overlay.style.display = "flex";
    if(fullChart) fullChart.destroy();
    fullChart = new Chart(document.getElementById("chartFullscreen").getContext("2d"), chartConfigs[currentChartIndex]);
  }

  function closeChart() {
    const overlay = document.getElementById("chartOverlay");
    overlay.style.display = "none";
    if (fullChart) fullChart.destroy();
  }
  
  document.querySelector(".close-btn").addEventListener("click", closeChart);

  // Render 3 chart
  renderChart('chartTx1Normal','TX1',tx1,tx1,degrees,'rgba(0,0,255,1)');
  renderChart('chartTx2Normal','TX2',tx2,tx2,degrees,'rgba(255,0,0,1)');
  renderMirrorCombined('chartMirrorCombined', degrees, tx1Mirror, tx2Mirror);
});

</script>

  {% block footer %}{% endblock %}
{% endblock %}
