{% extends "base.html" %}
{% block content %}
<div class="container my-5">
  <h2 class="mb-4 fw-bold text-center">EDIT GROUND CHECK LOCALIZER PERFORMANCE CURVE</h2>

  <form method="POST" action="{{ url_for('groundcheck.update', id=gc.id) }}">
    <div class="row mb-3">
      <div class="col-md-6">
        <label class="form-label fw-bold">Lokasi:</label>
        <select name="lokasi" class="form-select" required>
          <option value="AirNav Surabaya" {% if gc.lokasi == 'AirNav Surabaya' %}selected{% endif %}>AirNav Surabaya</option>
          <option value="AirNav Malang" {% if gc.lokasi == 'AirNav Malang' %}selected{% endif %}>AirNav Malang</option>
          <option value="AirNav Dhoho" {% if gc.lokasi == 'AirNav Dhoho' %}selected{% endif %}>AirNav Dhoho</option>
        </select>
      </div>
      <div class="col-md-6">
        <label class="form-label fw-bold">Tanggal:</label>
        <input type="date" name="tanggal" class="form-control" value="{{ gc.tanggal.strftime('%Y-%m-%d') }}" required>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-bordered text-center align-middle">
        <thead class="table-light">
          <tr>
            <th rowspan="2">FREQ</th>
            <th rowspan="2">JARAK (M)</th>
            <th rowspan="2">DEGREE (°)</th>
            <th colspan="6">TX 1</th>
            <th colspan="6">TX 2</th>
          </tr>
          <tr>
            <th>DDM (%)</th><th>DDM (µA)</th><th>SUM (%)</th>
            <th>MOD 90 Hz</th><th>MOD 150 Hz</th><th>RF LEVEL (dB)</th>
            <th>DDM (%)</th><th>DDM (µA)</th><th>SUM (%)</th>
            <th>MOD 90 Hz</th><th>MOD 150 Hz</th><th>RF LEVEL (dB)</th>
          </tr>
        </thead>
        <tbody>
          {% for row in gc.rows %}
          <tr>
            {% if loop.first or row.freq != gc.rows[loop.index0-1].freq %}
              <td rowspan="{{ gc.rows|selectattr('freq','equalto',row.freq)|list|length }}">{{ row.freq }}</td>
            {% endif %}
            <td>{{ row.jarak }}</td>
            <td>{{ row.degree }}</td>

            <!-- TX1 -->
            <td><input type="number" step="any" style="min-width:90px;" name="tx1_ddm_persen_{{ row.id }}" value="{{ row.tx1_ddm_persen or '' }}" class="form-control"></td>
            <td><input type="number" step="any" style="min-width:90px;" name="tx1_ddm_ua_{{ row.id }}" value="{{ row.tx1_ddm_ua or '' }}" class="form-control"></td>
            <td><input type="number" step="any" style="min-width:90px;" name="tx1_sum_{{ row.id }}" value="{{ row.tx1_sum or '' }}" class="form-control"></td>
            <td><input type="number" step="any" style="min-width:90px;" name="tx1_mod90_{{ row.id }}" value="{{ row.tx1_mod90 or '' }}" class="form-control"></td>
            <td><input type="number" step="any" style="min-width:90px;" name="tx1_mod150_{{ row.id }}" value="{{ row.tx1_mod150 or '' }}" class="form-control"></td>
            <td><input type="number" step="any" style="min-width:90px;" name="tx1_rf_{{ row.id }}" value="{{ row.tx1_rf or '' }}" class="form-control"></td>

            <!-- TX2 -->
            <td><input type="number" step="any" style="min-width:90px;" name="tx2_ddm_persen_{{ row.id }}" value="{{ row.tx2_ddm_persen or '' }}" class="form-control"></td>
            <td><input type="number" step="any" style="min-width:90px;" name="tx2_ddm_ua_{{ row.id }}" value="{{ row.tx2_ddm_ua or '' }}" class="form-control"></td>
            <td><input type="number" step="any" style="min-width:90px;" name="tx2_sum_{{ row.id }}" value="{{ row.tx2_sum or '' }}" class="form-control"></td>
            <td><input type="number" step="any" style="min-width:90px;" name="tx2_mod90_{{ row.id }}" value="{{ row.tx2_mod90 or '' }}" class="form-control"></td>
            <td><input type="number" step="any" style="min-width:90px;" name="tx2_mod150_{{ row.id }}" value="{{ row.tx2_mod150 or '' }}" class="form-control"></td>
            <td><input type="number" step="any" style="min-width:90px;" name="tx2_rf_{{ row.id }}" value="{{ row.tx2_rf or '' }}" class="form-control"></td>

          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="row mt-4">
     <div class="col-md-6">
  <label class="form-label fw-bold">Teknisi On Duty:</label>
  <div id="teknisi-container">
  {% if gc.teknisi_list %}
    {% for teknisi in gc.teknisi_list %}
      <input type="text" name="teknisi[]" value="{{ teknisi }}" class="form-control mb-2">
    {% endfor %}
  {% else %}
      <input type="text" name="teknisi[]" class="form-control mb-2" placeholder="Nama Teknisi">
  {% endif %}
</div>
  <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addField('teknisi')">+ Teknisi</button>
  <button type="button" class="btn btn-sm btn-outline-danger mt-2" onclick="removeField('teknisi')">❌</button>
</div>
      <div class="col-md-6">
        <label class="form-label fw-bold">Catatan:</label>
        <textarea name="catatan" class="form-control" rows="3">{{ gc.catatan }}</textarea>
      </div>
    </div>
    <div class="mt-4 d-flex justify-content-end gap-2">
      <button type="submit" class="btn btn-success">Simpan Perubahan</button>
      <a href="{{ url_for('groundcheck.lihat_data') }}" class="btn btn-secondary">Batal</a>
    </div>
  </form>
  <div class="container mt-5">
    <h4 class="fw-bold">Grafik Ground Check</h4>
    <canvas id="chartTx1Normal" class="mt-4"></canvas>
    <canvas id="chartTx2Normal" class="mt-4"></canvas>
    <canvas id="chartTxMirrorCombined" class="mt-4"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>

<script>
function addField(type) {
  const container = document.getElementById(`${type}-container`);
  const input = document.createElement("input");
  input.type = "text";
  input.name = `${type}[]`;
  input.className = "form-control mb-2";
  container.appendChild(input);
}

function removeField(type) {
  const container = document.getElementById(`${type}-container`);
  if (container.children.length > 1) {
    container.removeChild(container.lastElementChild);
  }
}

document.addEventListener("DOMContentLoaded", function() {
    let degrees = [35,30,25,20,15,10,5,1.85,0,1.85,5,10,15,20,25,30,35];

    let tx1 = JSON.parse('{{ gc.rows|map(attribute="tx1_ddm_persen")|list|tojson|safe }}');
    let tx2 = JSON.parse('{{ gc.rows|map(attribute="tx2_ddm_persen")|list|tojson|safe }}');

    function makeMirror(rawData) {
        let left  = [...rawData].slice(0,8);
        let right = [...rawData].slice(8);
        let rawMirror = left.concat(right);
        let plotMirror = rawMirror.map(v => v !== null ? Math.abs(v) : null);
        return { rawMirror, plotMirror };
    }

    let tx1Mirror = makeMirror(tx1);
    let tx2Mirror = makeMirror(tx2);

    function renderChart(canvasId, label, rawData, plotData, labels, color) {
        new Chart(document.getElementById(canvasId).getContext('2d'), {
            type: 'line',
            data: {
                labels: labels.map(d => d+"°"),
                datasets: [{
                    label: label,
                    data: plotData,
                    borderColor: color,
                    backgroundColor: color.replace('1)', '0.1)'),
                    pointBackgroundColor: color,
                    pointRadius: 4,
                    tension: 0.2,
                    rawValues: rawData
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: label + ' Ground Performance Curve',
                        font: { size: 18, weight: 'bold' }
                    },
                    datalabels: {
                        color: 'black',
                        align: 'top',
                        font: { weight: 'bold' },
                        formatter: (value, ctx) => {
                            let raw = ctx.dataset.rawValues[ctx.dataIndex];
                            return raw !== null ? raw.toFixed(2) : '';
                        }
                    },
                    annotation: {
                        annotations: {
                            verticalLine: {
                                type: 'line',
                                xMin: labels.indexOf(0),
                                xMax: labels.indexOf(0),
                                borderColor: 'black',
                                borderWidth: 2
                            },
                            horizontalLine: {
                                type: 'line',
                                yMin: 0,
                                yMax: 0,
                                borderColor: 'black',
                                borderWidth: 2
                            }
                        }
                    }
                },
                scales: {
                    x: { title: { display: true, text: 'Degree (°)' } },
                    y: { title: { display: true, text: 'DDM (%)' } }
                }
            },
            plugins: [ChartDataLabels]
        });
    }

    function renderMirrorCombined(canvasId, labels, tx1Mirror, tx2Mirror) {
        new Chart(document.getElementById(canvasId).getContext('2d'), {
            type: 'line',
            data: {
                labels: labels.map(d => d+"°"),
                datasets: [
                    {
                        label: 'TX1 Mirror',
                        data: tx1Mirror.plotMirror,
                        borderColor: 'rgba(0,0,255,1)',
                        backgroundColor: 'rgba(0,0,255,0.1)',
                        pointBackgroundColor: 'rgba(0,0,255,1)',
                        pointRadius: 4,
                        tension: 0.2,
                        rawValues: tx1Mirror.rawMirror
                    },
                    {
                        label: 'TX2 Mirror',
                        data: tx2Mirror.plotMirror,
                        borderColor: 'rgba(255,0,0,1)',
                        backgroundColor: 'rgba(255,0,0,0.1)',
                        pointBackgroundColor: 'rgba(255,0,0,1)',
                        pointRadius: 4,
                        tension: 0.2,
                        rawValues: tx2Mirror.rawMirror
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'TX1 & TX2 Mirror Ground Performance Curve',
                        font: { size: 18, weight: 'bold' }
                    },
                    datalabels: {
                        color: 'black',
                        align: 'top',
                        font: { weight: 'bold' },
                        formatter: (value, ctx) => {
                            let raw = ctx.dataset.rawValues[ctx.dataIndex];
                            return raw !== null ? raw.toFixed(2) : '';
                        }
                    },
                    annotation: {
                        annotations: {
                            verticalLine: {
                                type: 'line',
                                xMin: labels.indexOf(0),
                                xMax: labels.indexOf(0),
                                borderColor: 'black',
                                borderWidth: 2
                            },
                            horizontalLine: {
                                type: 'line',
                                yMin: 0,
                                yMax: 0,
                                borderColor: 'black',
                                borderWidth: 2
                            }
                        }
                    }
                },
                scales: {
                    x: { title: { display: true, text: 'Degree (°)' } },
                    y: { title: { display: true, text: 'DDM (%)' } }
                }
            },
            plugins: [ChartDataLabels]
        });
    }

    // Render grafik
    renderChart('chartTx1Normal', 'TX1 Normal', tx1, tx1, degrees, 'rgba(0,0,255,1)');
    renderChart('chartTx2Normal', 'TX2 Normal', tx2, tx2, degrees, 'rgba(255,0,0,1)');
    renderMirrorCombined('chartTxMirrorCombined', degrees, tx1Mirror, tx2Mirror);
});
</script>

{% endblock %}
{% block footer %}{% endblock %}
