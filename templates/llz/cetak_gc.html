{% extends "base.html" %}
{% block content %}
<div class="container my-4" id="print-area">
  <div class="text-center mb-4 print-header">
    <img src="{{ url_for('static', filename='img/airnav_logo.png') }}" alt="AirNav Logo" style="height:80px; margin-bottom:15px;">
    <h5 class="fw-bold">PERUM LPPNPI - KANTOR CABANG {{ record.lokasi|upper }}</h5>
    <h4 class="fw-bold">GROUND CHECK LOCALIZER PERFORMANCE CURVE</h4>
  </div>

  <div class="row mb-4 info-umum">
    <div class="col-md-6">
      <p><strong>Tanggal:</strong> {{ record.tanggal.strftime('%d-%m-%Y') }}</p>
      <p><strong>Fasilitas:</strong> Instrument Landing System</p>
      <p><strong>Merk:</strong> Mopiens 510</p>
      <p><strong>Ident-Freq:</strong> ISBY - 110.10 MHz</p>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-bordered text-center align-middle">
      <thead class="table-secondary">
        <tr>
          <th rowspan="2">FREQ</th>
          <th rowspan="2">JARAK (M)</th>
          <th rowspan="2">DEGREE (¬∞)</th>
          <th colspan="6">TX 1</th>
          <th colspan="6">TX 2</th>
        </tr>
        <tr>
          <th>DDM (%)</th><th>DDM (¬µA)</th><th>SUM (%)</th>
          <th>MOD 90 Hz</th><th>MOD 150 Hz</th><th>RF LEVEL (dB)</th>
          <th>DDM (%)</th><th>DDM (¬µA)</th><th>SUM (%)</th>
          <th>MOD 90 Hz</th><th>MOD 150 Hz</th><th>RF LEVEL (dB)</th>
        </tr>
      </thead>
      <tbody>
        {% set data_90hz = rows | selectattr("freq","equalto","90 Hz") | list %}
        {% set data_center = rows | selectattr("freq","equalto","Center") | list %}
        {% set data_150hz = rows | selectattr("freq","equalto","150 Hz") | list %}

        {% for row in data_90hz %}
        <tr>
          {% if loop.first %}<td rowspan="{{ data_90hz|length }}">90 Hz</td>{% endif %}
          <td>{{ row.jarak }}</td>
          <td>{{ row.degree }}</td>
          <td>{{ row.tx1_ddm_persen or '' }}</td>
          <td>{{ row.tx1_ddm_ua or '' }}</td>
          <td>{{ row.tx1_sum or '' }}</td>
          <td>{{ row.tx1_mod90 or '' }}</td>
          <td>{{ row.tx1_mod150 or '' }}</td>
          <td>{{ row.tx1_rf or '' }}</td>
          <td>{{ row.tx2_ddm_persen or '' }}</td>
          <td>{{ row.tx2_ddm_ua or '' }}</td>
          <td>{{ row.tx2_sum or '' }}</td>
          <td>{{ row.tx2_mod90 or '' }}</td>
          <td>{{ row.tx2_mod150 or '' }}</td>
          <td>{{ row.tx2_rf or '' }}</td>
        </tr>
        {% endfor %}

        {% for row in data_center %}
        <tr>
          {% if loop.first %}<td rowspan="{{ data_center|length }}"></td>{% endif %}
          <td>{{ row.jarak }}</td>
          <td>{{ row.degree }}</td>
          <td>{{ row.tx1_ddm_persen or '' }}</td>
          <td>{{ row.tx1_ddm_ua or '' }}</td>
          <td>{{ row.tx1_sum or '' }}</td>
          <td>{{ row.tx1_mod90 or '' }}</td>
          <td>{{ row.tx1_mod150 or '' }}</td>
          <td>{{ row.tx1_rf or '' }}</td>
          <td>{{ row.tx2_ddm_persen or '' }}</td>
          <td>{{ row.tx2_ddm_ua or '' }}</td>
          <td>{{ row.tx2_sum or '' }}</td>
          <td>{{ row.tx2_mod90 or '' }}</td>
          <td>{{ row.tx2_mod150 or '' }}</td>
          <td>{{ row.tx2_rf or '' }}</td>
        </tr>
        {% endfor %}

        {% for row in data_150hz %}
        <tr>
          {% if loop.first %}<td rowspan="{{ data_150hz|length }}">150 Hz</td>{% endif %}
          <td>{{ row.jarak }}</td>
          <td>{{ row.degree }}</td>
          <td>{{ row.tx1_ddm_persen or '' }}</td>
          <td>{{ row.tx1_ddm_ua or '' }}</td>
          <td>{{ row.tx1_sum or '' }}</td>
          <td>{{ row.tx1_mod90 or '' }}</td>
          <td>{{ row.tx1_mod150 or '' }}</td>
          <td>{{ row.tx1_rf or '' }}</td>
          <td>{{ row.tx2_ddm_persen or '' }}</td>
          <td>{{ row.tx2_ddm_ua or '' }}</td>
          <td>{{ row.tx2_sum or '' }}</td>
          <td>{{ row.tx2_mod90 or '' }}</td>
          <td>{{ row.tx2_mod150 or '' }}</td>
          <td>{{ row.tx2_rf or '' }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="page-break"></div>

 <div class="row mt-4">
  <div class="col-md-6 mb-4">
    <canvas id="chartTx1Normal"></canvas>
  </div>
  <div class="col-md-6 mb-4">
    <canvas id="chartTx2Normal"></canvas>
  </div>
</div>
<div class="row mt-0">
  <div class="col-12">
    <canvas id="chartMirrorCombined"width="1000" height="300"></canvas>
  </div>
</div>
<!-- Tambahkan overlay fullscreen -->
<div id="chartOverlay" 
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
            background:rgba(0,0,0,0.8); z-index:9999; align-items:center; justify-content:center;">
  <div style="position:relative; width:95%; max-width:1200px; background:#fff; padding:10px; border-radius:8px;">
    <button class="close-btn" 
            style="position:absolute; top:10px; right:10px; background:red; color:white; border:none; padding:5px 10px; cursor:pointer;">
      ‚úñ
    </button>
    <canvas id="chartFullscreen"></canvas>
  </div>
</div>


  <div class="row mt-4">
    <div class="col-12">
      <table class="table table-bordered align-middle" style="width:100%;">
        <tr>
          <td style="width:60%;">
            <strong>Teknisi On Duty :</strong>
            <ol style="margin-top:10px; margin-bottom:10px;">
              {% for t in record.teknisi.split(',') %}
                <li>{{ t.strip() }}</li>
              {% endfor %}
            </ol>
          </td>
          <td style="width:40%;">
            <strong>Paraf :</strong>
            <ol style="margin-top:10px; margin-bottom:10px; list-style-position: inside;">
              {% for t in record.teknisi.split(',') %}
                <li>&nbsp;</li>
              {% endfor %}
            </ol>
          </td>
        </tr>
      </table>
    </div>
  </div>
  <div class="row mt-2">
  <div class="col-12 text-center">
    <p class="mb-1"><strong>MANAGER TEKNIK</strong></p>
    {% if record.barcode_path %}
      <div class="text-center mt-1 mb-1">
        <img src="{{ url_for('static', filename=record.barcode_path.replace('static/', '')) }}" 
             alt="Barcode Manager" 
             style="width: 100px; margin-bottom: 2px;">
      </div>
    {% endif %}
    <p class="mb-0" style="text-decoration: none; margin-top: 2px;">{{ record.manager }}</p>
  </div>
</div>


  <div class="text-end mb-5 no-print">
    <button class="btn btn-outline-dark rounded-0 " onclick="window.print()">üñ®Ô∏è PDF</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  let degrees = [35,30,25,20,15,10,5,1.85,0,1.85,5,10,15,20,25,30,35];

  let tx1_data = '{{ rows|map(attribute="tx1_ddm_persen")|map("default",0)|list|tojson|safe }}';
  let tx2_data = '{{ rows|map(attribute="tx2_ddm_persen")|map("default",0)|list|tojson|safe }}';

  let tx1 = JSON.parse(tx1_data);
  let tx2 = JSON.parse(tx2_data);

  function makeMirror(rawData) {
    let left = rawData.slice(0,8);
    let right = rawData.slice(8);
    let rawMirror = left.concat(right);
    let plotMirror = rawMirror.map(v => Math.abs(v));
    return { rawMirror, plotMirror };
  }

  let tx1Mirror = makeMirror(tx1);
  let tx2Mirror = makeMirror(tx2);

  function renderChart(canvasId, label, rawData, plotData, labels, color) {
    let ctx = document.getElementById(canvasId).getContext('2d');
    return new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels.map(d => d + "¬∞"),
        datasets: [{
          label: label,
          data: plotData,
          borderColor: color,
          backgroundColor: color.replace('1)', '0.1)'),
          pointBackgroundColor: color,
          pointRadius: 4,
          tension: 0.2,
          rawValues: rawData
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          title: {
            display: true,
            text: label + ' Ground Performance Curve',
            font: { size: 16, weight: 'bold' }
          },
          datalabels: {
            color: 'black',
            align: 'top',
            font: { weight: 'bold', size: 10 },
            formatter: (value, ctx) => ctx.dataset.rawValues[ctx.dataIndex]?.toFixed(2) || ''
          },
          annotation: {
            annotations: {
              verticalLine: {
                type: 'line',
                xMin: labels.indexOf(0),
                xMax: labels.indexOf(0),
                borderColor: 'black',
                borderWidth: 2
              },
              horizontalLine: {
                type: 'line',
                yMin: 0,
                yMax: 0,
                borderColor: 'black',
                borderWidth: 2
              }
            }
          }
        },
        scales: {
          x: { title: { display: true, text: 'Degree (¬∞)' } },
          y: { title: { display: true, text: 'DDM (%)' } }
        }
      },
      plugins: [ChartDataLabels]
    });
  }

  // Normal
  renderChart('chartTx1Normal', 'TX1 ', tx1, tx1, degrees, 'rgba(0,0,255,1)');
  renderChart('chartTx2Normal', 'TX2 ', tx2, tx2, degrees, 'rgba(255,0,0,1)');

  // Combined Mirror
  new Chart(document.getElementById('chartMirrorCombined').getContext('2d'), {
    type: 'line',
    data: {
      labels: degrees.map(d => d + "¬∞"),
      datasets: [
        {
          label: 'TX1',
          data: tx1Mirror.plotMirror,
          borderColor: 'rgba(0,0,255,1)',
          backgroundColor: 'rgba(0,0,255,0.1)',
          pointBackgroundColor: 'rgba(0,0,255,1)',
          pointRadius: 4,
          tension: 0.2,
          rawValues: tx1Mirror.rawMirror
        },
        {
          label: 'TX2',
          data: tx2Mirror.plotMirror,
          borderColor: 'rgba(255,0,0,1)',
          backgroundColor: 'rgba(255,0,0,0.1)',
          pointBackgroundColor: 'rgba(255,0,0,1)',
          pointRadius: 4,
          tension: 0.2,
          rawValues: tx2Mirror.rawMirror
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        title: {
          display: true,
          text: 'TX1 & TX2 Ground Performance Curve',
          font: { size: 16, weight: 'bold' }
        },
        datalabels: {
          color: 'black',
          align: 'top',
          font: { weight: 'bold', size: 10 },
          formatter: (value, ctx) => ctx.dataset.rawValues[ctx.dataIndex]?.toFixed(2) || ''
        },
        annotation: {
          annotations: {
            verticalLine: {
              type: 'line',
              xMin: degrees.indexOf(0),
              xMax: degrees.indexOf(0),
              borderColor: 'black',
              borderWidth: 2
            },
            horizontalLine: {
              type: 'line',
              yMin: 0,
              yMax: 0,
              borderColor: 'black',
              borderWidth: 2
            }
          }
        }
      },
      scales: {
        x: { title: { display: true, text: 'Degree (¬∞)' } },
        y: { title: { display: true, text: 'DDM (%)' } }
      }
    },
    plugins: [ChartDataLabels]
  });
});

</script>


<style>
  
@media print {
  @page {
    size: A4 landscape; 
    margin: 5mm; 
  }

  .no-print { display: none !important; }
  .page-break { page-break-before: always; }

 
  .print-header h5 {
    font-size: 11px !important;
    margin-bottom: 2px;
  }
  .print-header h4 {
    font-size: 13px !important;
    margin-bottom: 5px;
  }
  .print-header img {
    height: 50px !important;
  }

 
  .info-umum p {
    font-size: 9px !important; 
    margin: 1px 0;
  }


  .table-responsive {
    page-break-inside: avoid;
    width: 100% !important;
    transform: none !important; 
  }

  table {
    width: 100% !important;
    font-size: 11px !important;
    table-layout: fixed;
  }

  th, td {
    padding: 2px 3px !important;
  }
}


header, footer, nav, .sidebar, .navbar {
  display: none !important;
  visibility: hidden !important;
}

body * {
  visibility: hidden;
}

#print-area, #print-area * {
  visibility: visible;
}

#print-area {
  width: 100% !important;
  margin: 0 auto;
  padding: 0;
}


  
  canvas {
    max-width: 100% !important;
    height: auto !important;
    page-break-inside: avoid;
  }



</style>
{% endblock %}
{% block footer %}{% endblock %}
